rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    // 
    // IMPORTANT: This function must be kept in sync with FirebaseConfig.isAdmin()
    // in lib/config/firebase_config.dart. When updating admin emails/UIDs:
    // 1. Update lib/config/admin_config.dart (source of truth)
    // 2. Update this function in firestore.rules
    // 3. The FirebaseConfig.isAdmin() function reads from admin_config.dart
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email in ['aqela.af@gmail.com', 'matteo.magnini00@gmail.com'] ||
        request.auth.uid in ['RjUAlHp2LCY0TybQrsNuL9avEyA3', '1mTOnYw5kNSlDJAY02htpSLmdS43']
      );
    }
    
    // Users collection: stores all registered users that sign up and login
    // Users can create, read, update, and delete their own profile
    match /users/{userId} {
      // Allow users to create their own profile during signup
      // The document ID must match the authenticated user's UID
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to delete their own profile (optional, for account deletion)
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Chat logs collection: users can write their own logs, read their own logs, admins can read all
    match /chat_logs/{logId} {
      // Users can create logs (write) if authenticated and the uid matches
      allow create: if request.auth != null && 
                      request.resource.data.uid == request.auth.uid;
      
      // Users can read their own logs
      allow read: if request.auth != null && 
                   (resource.data.uid == request.auth.uid || isAdmin());
      
      // Users can update/delete their own logs (if needed in future)
      allow update, delete: if request.auth != null && 
                             resource.data.uid == request.auth.uid;
    }
    
    // Admin logs collection (if used)
    match /admin_logs/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

